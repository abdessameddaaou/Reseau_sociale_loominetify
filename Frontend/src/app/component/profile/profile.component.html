<div class="min-h-screen app-bg flex flex-col" id="profile-page" data-testid="profile-page">
  <!-- HEADER -->
  <app-header
    [activeTab]="activeTab"
    (tabChange)="setActiveTab($event)"
    id="profile-header"
    data-testid="profile-header">
  </app-header>

  <!-- BODY -->
  <main class="flex-1" id="profile-main" data-testid="profile-main">
    <div
      class="max-w-6xl mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6"
      id="profile-layout"
      data-testid="profile-layout">

      <!-- COLONNE GAUCHE : résumé + amis + groupes -->
      <aside
        class="w-full lg:w-72 space-y-4"
        id="profile-sidebar"
        data-testid="profile-sidebar">

        <!-- Carte profil principale -->
        <section
          class="app-card rounded-2xl shadow-sm overflow-hidden"
          id="profile-hero-card"
          data-testid="profile-hero-card">
          <div class="h-20 accent-gradient"></div>

          <div class="p-4 -mt-10 flex flex-col items-center text-center">
            <img
              [src]="currentUser?.photo || defaultAvatar"
              alt="avatar"
              class="w-20 h-20 rounded-full border-4 border-white object-cover shadow"
              id="profile-avatar"
              data-testid="profile-avatar" />

            <h1
              class="mt-2 text-base font-semibold text-slate-900"
              id="profile-name"
              data-testid="profile-name">
              {{ currentUser?.nom }} {{ currentUser?.prenom }}
            </h1>

            <p
              class="text-[12px] text-slate-400"
              id="profile-handle"
              data-testid="profile-handle">
              @{{ currentUser?.nom }}{{ currentUser?.prenom }}
            </p>

            <p
              class="mt-1 text-[11px] text-slate-500 flex items-center gap-1"
              id="profile-location">
              <i class="fa-solid fa-location-dot text-[10px]"></i>
              <span>{{ currentUser?.ville || 'Non renseigné' }}</span>
            </p>

            <div
              class="mt-4 flex justify-between w-full text-xs text-slate-700"
              id="profile-header-stats"
              data-testid="profile-header-stats">
              <div class="flex-1 text-center">
                <p class="font-semibold">{{ followers }}</p>
                <p class="text-[11px] text-slate-400">Abonnés</p>
              </div>
              <div class="flex-1 text-center">
                <p class="font-semibold">{{ following }}</p>
                <p class="text-[11px] text-slate-400">Abonnements</p>
              </div>
              <div class="flex-1 text-center">
                <p class="font-semibold">{{ postsCount }}</p>
                <p class="text-[11px] text-slate-400">Publications</p>
              </div>
            </div>

            <div class="mt-4 flex gap-2 w-full">
              <button
                type="button"
                class="flex-1 rounded-full btn-primary-gradient text-[11px] font-semibold py-1.5 shadow-md"
                (click)="goToEditProfile()"
                id="profile-edit-button"
                data-testid="profile-edit-button">
                Modifier mon profil
              </button>
            </div>

            <p
              class="mt-3 text-[11px] text-slate-400"
              id="profile-member-since"
              data-testid="profile-member-since">
              Membre depuis {{ joinedDate }}
            </p>
          </div>
        </section>

        <!-- Amis proches -->
        <section
          class="app-card rounded-2xl shadow-sm p-4 space-y-3"
          id="profile-friends-card"
          data-testid="profile-friends-card">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              Amis
            </h2>
            <span
              class="text-[11px] text-slate-400"
              id="profile-friends-count"
              data-testid="profile-friends-count">
              {{ Friends.length }}
            </span>
          </div>

          <div class="space-y-2">
            <button
              type="button"
              *ngFor="let friend of Friends"
              class="w-full flex items-center gap-3 rounded-xl px-2 py-2 hover:bg-slate-50 transition"
              (click)="openFriend(friend)"
              [attr.data-testid]="'profile-friend-' + friend.id">
              <div class="relative">
                <img
                  [src]="friend.avatar"
                  [alt]="friend.name"
                  class="w-8 h-8 rounded-full object-cover" />
                <span
                  class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white"
                  [ngClass]="friend.online ? 'bg-emerald-400' : 'bg-slate-300'">
                </span>
              </div>
              <div class="flex-1 text-left">
                <p class="text-xs font-semibold text-slate-800">
                  {{ friend.name }}
                </p>
                <p class="text-[11px] text-slate-400">
                  @{{ friend.handle }} · {{ friend.mutual }} amis en commun
                </p>
              </div>
            </button>
          </div>
        </section>

        <!-- Groupes -->
        <section
          class="app-card rounded-2xl shadow-sm p-4 space-y-3"
          id="profile-groups-card"
          data-testid="profile-groups-card">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              Groupes
            </h2>
            <span
              class="text-[11px] text-slate-400"
              id="profile-groups-count"
              data-testid="profile-groups-count">
              {{ groups.length }}
            </span>
          </div>

          <div class="space-y-2">
            <button
              type="button"
              *ngFor="let group of groups"
              class="w-full flex items-center gap-3 rounded-xl px-2 py-2 hover:bg-slate-50 transition"
              (click)="openGroup(group)"
              [attr.data-testid]="'profile-group-' + group.id">
              <img
                [src]="group.avatar"
                [alt]="group.name"
                class="w-8 h-8 rounded-xl object-cover" />
              <div class="flex-1 text-left">
                <p class="text-xs font-semibold text-slate-800 truncate">
                  {{ group.name }}
                </p>
                <p class="text-[11px] text-slate-400">
                  {{ group.members }} membres · {{ group.role }}
                </p>
                <p class="text-[10px] text-slate-400">
                  {{ group.lastActivity }}
                </p>
              </div>
            </button>
          </div>
        </section>
      </aside>

      <!-- COLONNE DROITE : contenu principal -->
      <section
        class="flex-1 space-y-4"
        id="profile-content"
        data-testid="profile-content">

        <!-- Bio / résumé -->
        <section
          class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-3"
          id="profile-bio-card"
          data-testid="profile-bio-card">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              À propos
            </h2>
            <span class="text-[11px] text-emerald-500 flex items-center gap-1">
              <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
              En ligne
            </span>
          </div>

          <p class="text-[13px] text-slate-700 leading-relaxed">
            {{ currentUser?.bio || 'Non renseigné' }}
          </p>
        </section>

        <!-- Coordonnées + infos compte -->
        <section
          class="grid md:grid-cols-2 gap-4"
          id="profile-details-grid"
          data-testid="profile-details-grid">

          <!-- Coordonnées -->
          <div
            class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-2 text-[13px]"
            id="profile-contact-card"
            data-testid="profile-contact-card">
            <h2 class="text-sm font-semibold text-slate-900 mb-1">
              Coordonnées
            </h2>

            <div class="space-y-1 text-slate-600">
              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Email
                </span>
                <br />
                {{ currentUser?.email || 'Non renseigné' }}
              </p>

              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Téléphone
                </span>
                <br />
                {{ currentUser?.telephone || 'Non renseigné' }}
              </p>

              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Pays de résidence
                </span>
                <br />
                {{ currentUser?.pays || 'Non renseigné' }}
              </p>
            </div>
          </div>

          <!-- Infos compte / perso -->
          <div
            class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-2 text-[13px]"
            id="profile-account-card"
            data-testid="profile-account-card">
            <h2 class="text-sm font-semibold text-slate-900 mb-1">
              Infos personnelles
            </h2>

            <div class="space-y-1 text-slate-600">


              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Statut relationnel
                </span>
                <br />
                {{ currentUser?.relationStatus || 'Non renseigné' }}
              </p>

              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Profession
                </span>
                <br />
                {{ currentUser?.profession || 'Non renseigné'}}
              </p>

              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Âge
                </span>
                <br />
                {{ age }}
              </p>

              <p>
                <span class="font-semibold text-slate-500 text-[11px] uppercase tracking-wide">
                  Site web
                </span>
                <br />
                <ng-container *ngIf="currentUser?.siteweb; else nositeweb">
                  <a
                    [href]="currentUser?.siteweb"
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-[#5b7cff] hover:text-[#8b5cf6] hover:underline break-all">
                    {{ currentUser?.siteweb || 'Non renseigné' }}
                  </a>
                </ng-container>
                <ng-template #nositeweb>
                  Non renseigné
                </ng-template>
              </p>
            </div>
          </div>
        </section>

        <!-- Activité + Stats -->
        <section
          class="grid lg:grid-cols-[1.4fr,1fr] gap-4"
          id="profile-activity-grid"
          data-testid="profile-activity-grid">

          <!-- Activité récente -->
          <div
            class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-3 text-[13px]"
            id="profile-activity-card"
            data-testid="profile-activity-card">
            <div class="flex items-center justify-between">
              <h2 class="text-sm font-semibold text-slate-900">
                Dernières activités
              </h2>
              <button
                type="button"
                class="text-[11px] text-[#5b7cff] hover:text-[#8b5cf6] hover:underline"
                id="profile-activity-see-all"
                data-testid="profile-activity-see-all">
                Voir tout
              </button>
            </div>

            <div class="space-y-2">
              <div
                *ngFor="let item of recentActivity"
                class="flex items-start gap-3 text-slate-600"
                [attr.data-testid]="'profile-activity-item-' + item.id">
                <div
                  class="w-7 h-7 rounded-full bg-slate-100 flex items-center justify-center flex-shrink-0">
                  <i
                    class="fa-solid"
                    [ngClass]="{
                      'fa-comment-dots': item.icon === 'comment',
                      'fa-star': item.icon === 'star',
                      'fa-user-group': item.icon === 'group'
                    }">
                  </i>
                </div>
                <div class="flex-1">
                  <p>{{ item.text }}</p>
                  <p class="text-[11px] text-slate-400">
                    {{ item.timeAgo }}
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Stats & badges -->
          <div
            class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-4"
            id="profile-stats-card"
            data-testid="profile-stats-card">
            <h2 class="text-sm font-semibold text-slate-900">
              Statistiques & centres d’intérêt
            </h2>

            <div class="grid grid-cols-3 gap-2 text-xs">
              <div
                class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-center">
                <p class="text-slate-900 font-semibold">
                  {{ stats.activityScore }}
                </p>
                <p class="text-[11px] text-slate-500">
                  Score d’activité
                </p>
              </div>
              <div
                class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-center">
                <p class="text-slate-900 font-semibold">
                  {{ stats.daysStreak }}
                </p>
                <p class="text-[11px] text-slate-500">
                  Jours consécutifs
                </p>
              </div>
              <div
                class="rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-center">
                <p class="text-slate-900 font-semibold">
                  {{ stats.groupsJoined }}
                </p>
                <p class="text-[11px] text-slate-500">
                  Groupes rejoints
                </p>
              </div>
            </div>

            <div class="flex flex-wrap gap-2 text-[11px]">
              <span
                *ngFor="let tag of badges"
                class="px-3 py-1 rounded-full bg-slate-100 text-slate-700 border border-slate-200"
                [attr.data-testid]="'profile-badge-' + tag">
                #{{ tag }}
              </span>
            </div>
          </div>
        </section>

        <!-- Photos récentes -->
        <section
          class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-4"
          id="profile-photos-card"
          data-testid="profile-photos-card">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              Photos récentes
            </h2>
            <span class="text-[11px] text-slate-400">
              {{ Photos.length }} photos
            </span>
          </div>

          <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
            <button
              *ngFor="let photo of Photos; let i = index"
              type="button"
              class="relative group rounded-xl overflow-hidden aspect-square bg-slate-100"
              (click)="openPhoto(photo)"
              [attr.data-testid]="'profile-photo-' + i">
              <img
                [src]="photo"
                alt="photo"
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
              <div
                class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
            </button>
          </div>
        </section>

        <!-- Dernières publications -->
        <section
          class="app-card rounded-2xl shadow-sm p-4 md:p-5 space-y-4"
          id="profile-posts-card"
          data-testid="profile-posts-card">

          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">
              Mes publications
            </h2>
          </div>

          <div class="space-y-3">
            <article
              *ngFor="let post of Publications"
              class="rounded-2xl border border-slate-200 bg-white px-3 py-3 shadow-[0_4px_12px_rgba(15,23,42,0.04)] hover:-translate-y-[1px] hover:shadow-md transition flex gap-3 items-start"
              [attr.data-testid]="'profile-post-item-' + post.id">

              <div class="mt-0.5 flex flex-col items-center gap-1">
                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center">
                  <i class="fa-solid fa-pen text-[11px] text-slate-500"></i>
                </div>
                <span class="w-px h-6 bg-slate-100"></span>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <p class="text-xs font-semibold text-slate-900">
                      {{ currentUser?.nom }} {{ currentUser?.prenom }}
                    </p>
                    <p class="text-[11px] text-slate-400">
                      @{{ currentUser?.nom }} · {{ post.timeAgo }}
                    </p>
                  </div>

                  <button
                    type="button"
                    class="px-3 py-1 rounded-full border border-slate-200 text-[11px] text-slate-600 bg-slate-50 hover:bg-slate-100 hover:text-slate-800 transition"
                    (click)="openPost(post)"
                    [attr.data-testid]="'profile-post-open-' + post.id">
                    Aperçu
                  </button>
                </div>

                <p class="mt-1 text-[13px] text-slate-700">
                  {{ post.description }}
                </p>
                <div *ngIf="post.image" class="mt-2">
                <img
                  [src]="srcImage(post.image)"
                  class="w-[100px] h-[100px] rounded-xl border border-slate-200 object-cover"
                  alt="post image"
                />
              </div>

                <div class="mt-2 flex items-center gap-4 text-[11px] text-slate-500">
                  <span class="inline-flex items-center gap-1">
                    <i class="fa-solid fa-heart text-[10px] text-[#e11d48]"></i>
                    {{ post.likes }}
                  </span>
                  <span class="inline-flex items-center gap-1">
                    <i class="fa-solid fa-comment text-[10px] text-[#0ea5e9]"></i>
                    {{ post.commentaires }}
                  </span>
                </div>
              </div>
            </article>

            <p
              *ngIf="Publications.length === 0"
              class="text-[12px] text-slate-500 text-center py-2">
              Aucune publication récente.
            </p>
          </div>
        </section>
      </section>
    </div>
  </main>
  <div
  *ngIf="selectedPhoto"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity"
  (click)="closePhotoModal()"
>
  <button
    class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors"
    (click)="closePhotoModal()"
  >
    <i class="fa-solid fa-xmark fa-2xl"></i>
  </button>

  <img
    [src]="selectedPhoto"
    alt="Photo agrandie"
    class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg shadow-2xl animate-in fade-in zoom-in duration-300"
    (click)="$event.stopPropagation()"
  />
</div>
</div>
