<div class="min-h-screen app-bg flex flex-col" id="messages-page" data-testid="messages-page">
  <!-- HEADER -->
  <app-header [activeTab]="activeTab" (tabChange)="setActiveTab($event)" id="messages-header"
    data-testid="messages-header">
  </app-header>

  <!-- CONTENU -->
  <div class="flex-1 flex px-6 pt-4 pb-4" id="messages-layout" data-testid="messages-layout">
    <div class="mx-auto w-full max-w-7xl flex flex-col gap-4 lg:flex-row" id="messages-container"
      data-testid="messages-container">
      <!-- COLONNE GAUCHE : LISTE DES CONVERSATIONS -->
      <aside class="app-card rounded-2xl p-4 w-full lg:w-80 flex flex-col" id="messages-sidebar"
        data-testid="messages-sidebar">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold text-slate-900" id="messages-title" data-testid="messages-title">
            Messages
          </h2>
          <button
            class="inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-medium text-white btn-primary-gradient shadow-md"
            id="messages-new-button" data-testid="messages-new-button" type="button">
            <span class="text-base leading-none">+</span>
            Nouveau
          </button>
        </div>

        <!-- Switch Tous / Messages / Groupes -->
        <div class="flex items-center gap-1 mb-3 text-xs app-soft rounded-full p-1" id="messages-filter-switch"
          data-testid="messages-filter-switch">
          <button (click)="setFilter('all')" class="flex-1 px-3 py-1 rounded-full transition" [ngClass]="
              filterMode === 'all'
                ? 'bg-white shadow text-slate-900'
                : 'text-slate-500'
            " id="messages-filter-all" data-testid="messages-filter-all" type="button">
            Tous
          </button>
          <button (click)="setFilter('direct')" class="flex-1 px-3 py-1 rounded-full transition" [ngClass]="
              filterMode === 'direct'
                ? 'bg-white shadow text-slate-900'
                : 'text-slate-500'
            " id="messages-filter-direct" data-testid="messages-filter-direct" type="button">
            Messages
          </button>
          <button (click)="setFilter('group')" class="flex-1 px-3 py-1 rounded-full transition" [ngClass]="
              filterMode === 'group'
                ? 'bg-white shadow text-slate-900'
                : 'text-slate-500'
            " id="messages-filter-group" data-testid="messages-filter-group" type="button">
            Groupes
          </button>
        </div>

        <div class="mb-3">
          <input type="text" placeholder="Rechercher une conversation"
            class="w-full text-sm rounded-full border-0 bg-slate-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
            [(ngModel)]="searchTerm" id="messages-search-input" name="messages-search-input"
            data-testid="messages-search-input" />
        </div>

        <ul class="space-y-1 overflow-y-auto flex-1" id="conversation-list" data-testid="conversation-list">
          <li *ngFor="let conv of filteredConversations" (click)="selectConversation(conv)"
            class="conv-item flex items-center gap-3 rounded-2xl px-3 py-3 cursor-pointer transition" [ngClass]="{
              'conv-item-active': selectedConversation?.id === conv.id,
              'conv-item-unread': conv.unread && selectedConversation?.id !== conv.id
            }" [attr.id]="'conversation-item-' + conv.id" [attr.data-testid]="'conversation-item-' + conv.id">
            <div class="relative w-11 h-11 flex-shrink-0">
              <img [src]="conv.avatar" [alt]="conv.name" class="w-full h-full rounded-full object-cover" />
              <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white"
                [ngClass]="conv.online ? 'bg-emerald-500' : 'bg-slate-400'"></span>
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between gap-2">
                <p class="text-sm font-semibold text-slate-900 truncate">
                  {{ conv.name }}
                </p>
                <span class="text-[11px] text-slate-400 whitespace-nowrap">
                  {{ conv.time }}
                </span>
              </div>
              <div class="flex items-center justify-between gap-2 mt-0.5">
                <p class="text-[12px] text-slate-500 truncate"
                  [ngClass]="{ 'font-medium text-slate-700': conv.unread }">
                  {{ conv.lastMessage }}
                </p>
                <span *ngIf="conv.unread"
                  class="inline-flex items-center justify-center min-w-[18px] h-[18px] rounded-full toggle-accent-on text-[10px] text-white">
                  {{ conv.unread }}
                </span>
              </div>
            </div>
          </li>

        </ul>
      </aside>

      <!-- COLONNE CENTRALE : CHAT -->
      <section class="app-card rounded-2xl p-4 flex-1 flex flex-col" id="chat-panel" data-testid="chat-panel">
        <!-- Si aucune conversation s√©lectionn√©e -->
        <div *ngIf="!selectedConversation"
          class="flex flex-1 items-center justify-center text-center text-slate-400 text-sm" id="chat-empty-state"
          data-testid="chat-empty-state">
          <div>
            <p class="font-semibold text-slate-500 mb-1">
              S√©lectionnez une conversation
            </p>
            <p>
              Choisissez une personne dans la liste √† gauche pour
              commencer.
            </p>
          </div>
        </div>

        <!-- Chat affich√© seulement si une conversation est s√©lectionn√©e -->
        <ng-container *ngIf="selectedConversation">
          <header class="flex items-center justify-between pb-3 mb-3 border-b border-slate-100" id="chat-header"
            data-testid="chat-header">
            <div class="flex items-center gap-3">
              <div class="relative w-11 h-11">
                <img [src]="selectedConversation.avatar" [alt]="selectedConversation.name"
                  class="w-full h-full rounded-full object-cover" />
                <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white" [ngClass]="
                    selectedConversation.online
                      ? 'bg-emerald-500'
                      : 'bg-slate-400'
                  "></span>
              </div>
              <div>
                <p class="text-sm font-semibold text-slate-900">
                  {{ selectedConversation.name }}
                </p>
                <p class="text-xs text-slate-400">
                  @{{ selectedConversation.username }}
                </p>
              </div>
            </div>

            <div class="flex items-center gap-2">
              <button class="rounded-full bg-slate-100 px-3 py-1 text-xs" title="Appel vocal" id="chat-call-audio"
                data-testid="chat-call-audio" type="button">
                üìû
              </button>
              <button class="rounded-full bg-slate-100 px-3 py-1 text-xs" title="Appel vid√©o" id="chat-call-video"
                data-testid="chat-call-video" type="button">
                üé•
              </button>
              <button class="rounded-full bg-slate-100 px-3 py-1 text-xs" title="Plus d'options" id="chat-more-options"
                data-testid="chat-more-options" type="button">
                ‚ãØ
              </button>
            </div>
          </header>

          <div class="flex-1 overflow-y-auto space-y-3 py-1" id="chat-messages-container"
            data-testid="chat-messages-container">
            <!-- S√©parateur de jour -->
            <div class="flex items-center justify-center my-2" id="chat-day-separator-today"
              data-testid="chat-day-separator-today">
              <span class="px-3 py-1 rounded-full bg-slate-100 text-[11px] text-slate-500">
                Aujourd'hui
              </span>
            </div>

            <!-- Messages -->
            <div *ngFor="let msg of currentMessages" class="flex flex-col max-w-[75%] space-y-1" [ngClass]="
                  msg.from === 'me'
                    ? 'ml-auto items-end'
                    : 'mr-auto items-start'
                " [attr.id]="'chat-message-' + msg.id" [attr.data-testid]="'chat-message-' + msg.id">
              <div class="px-3 py-2 rounded-2xl text-[13px] leading-snug shadow-md"
                [ngClass]="msg.from === 'me' ? 'chat-bubble-me' : 'chat-bubble-other'">
                {{ msg.content }}
              </div>
              <span class="text-[10px] text-slate-400">
                {{ msg.time }}
              </span>
            </div>

          </div>

          <footer class="mt-3 flex items-center gap-2 rounded-2xl chat-input-shell px-3 py-2" id="chat-input-footer"
            data-testid="chat-input-footer">
            <button class="rounded-full bg-white px-2 py-1 text-xs shadow-sm" title="Image" id="chat-attach-image"
              data-testid="chat-attach-image" type="button">
              üñºÔ∏è
            </button>
            <button class="rounded-full bg-white px-2 py-1 text-[11px] shadow-sm" title="GIF" id="chat-attach-gif"
              data-testid="chat-attach-gif" type="button">
              GIF
            </button>

            <textarea rows="1" [(ngModel)]="messageText" (keydown.enter)="sendMessage(); $event.preventDefault()"
              placeholder="√âcrivez un message..."
              class="flex-1 resize-none border-0 bg-transparent text-sm focus:outline-none focus:ring-0 px-2 py-1"
              id="chat-message-input" name="chat-message-input" data-testid="chat-message-input"></textarea>

            <button (click)="sendMessage()"
              class="rounded-full btn-primary-gradient px-4 py-1.5 text-xs font-semibold text-white shadow-md disabled:opacity-40"
              [disabled]="!messageText.trim()" id="chat-send-button" data-testid="chat-send-button" type="button">
              Envoyer
            </button>
          </footer>
        </ng-container>
      </section>

      <!-- COLONNE DROITE : INFOS CONVERSATION -->
      <aside class="w-full lg:w-72 space-y-4 hidden md:flex md:flex-col" id="messages-right-sidebar"
        data-testid="messages-right-sidebar">
        <!-- Profil -->
        <div class="rounded-2xl accent-gradient text-white p-5 shadow-xl" id="conversation-profile-card"
          data-testid="conversation-profile-card">
          <div class="flex flex-col items-center text-center">
            <div class="relative w-16 h-16 mb-3">
              <img [src]="selectedConversation?.avatar || defaultProfile.avatar"
                [alt]="selectedConversation?.name || defaultProfile.name"
                class="w-full h-full rounded-full object-cover border-4 border-white/20" />
              <span class="absolute bottom-0 right-0 w-3 h-3 rounded-full border-2 border-white" [ngClass]="
                  (selectedConversation || defaultProfile).online
                    ? 'bg-emerald-400'
                    : 'bg-slate-300'
                "></span>
            </div>
            <h3 class="text-sm font-semibold">
              {{ selectedConversation?.name || defaultProfile.name }}
            </h3>
            <p class="text-[12px] text-white/80">
              @{{ selectedConversation?.username || defaultProfile.username }}
            </p>
          </div>

          <div class="mt-4 flex justify-around text-[12px]">
            <div class="text-center">
              <span class="block text-white/80">Abonn√©s</span>
              <span class="block font-semibold">
                {{ defaultProfile.followers }}
              </span>
            </div>
            <div class="text-center">
              <span class="block text-white/80">Abonnements</span>
              <span class="block font-semibold">
                {{ defaultProfile.following }}
              </span>
            </div>
          </div>
        </div>

        <!-- Stats conversation -->
        <div class="app-card rounded-2xl p-4 text-[13px] text-slate-600" id="conversation-stats-card"
          data-testid="conversation-stats-card">
          <h4 class="text-sm font-semibold text-slate-900 mb-2">
            Infos de la conversation
          </h4>
          <ul class="space-y-2">
            <li class="flex justify-between">
              <span>Cr√©√©e</span>
              <span class="text-slate-500">12 mars 2025</span>
            </li>
            <li class="flex justify-between">
              <span>Photos partag√©es</span>
              <span class="text-slate-500">23</span>
            </li>
            <li class="flex justify-between">
              <span>Liens partag√©s</span>
              <span class="text-slate-500">8</span>
            </li>
          </ul>
        </div>

        <!-- Actions -->
        <div class="app-card rounded-2xl p-4 space-y-2" id="conversation-actions-card"
          data-testid="conversation-actions-card">
          <button class="w-full rounded-full border border-slate-200 px-3 py-2 text-xs text-slate-600 hover:bg-slate-50"
            id="conversation-mute-button" data-testid="conversation-mute-button" type="button">
            Mettre en sourdine
          </button>
          <button
            class="w-full rounded-full border border-rose-200 px-3 py-2 text-xs text-rose-600 bg-rose-50 hover:bg-rose-100"
            id="conversation-block-button" data-testid="conversation-block-button" type="button">
            Bloquer / Signaler
          </button>
        </div>
      </aside>
    </div>
  </div>
</div>